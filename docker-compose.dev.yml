services:
  # ---------------------------------------------
  # BACKEND - Abilita Django Dev Server
  # ---------------------------------------------
  backend:
    build:
      context: ./backend
      target: development
    # Sovrascrive il comando gunicorn di produzione
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      # Monta il codice sorgente per rilevare modifiche .py
      - ./backend:/app
      # Assicura che i media files siano accessibili
      - dev_media_volume:/app/media
    environment:
      - DEBUG=True

  # ---------------------------------------------
  # FRONTEND USER - Abilita Vite Dev Server
  # ---------------------------------------------
  frontend-user:
    build:
      context: ./frontend-user
      target: development
    volumes:
      # Sync bidirezionale codice host <-> container
      - ./frontend-user:/app
      # CRITICO: Preserva i node_modules del container evitando
      # che vengano sovrascritti dalla cartella locale (se assente)
      - /app/node_modules
    environment:
      # Polling necessario su alcuni sistemi (es. WSL2, Docker Desktop Windows)
      - CHOKIDAR_USEPOLLING=true

  # ---------------------------------------------
  # FRONTEND ADMIN - Abilita Vite Dev Server
  # ---------------------------------------------
  frontend-admin:
    build:
      context: ./frontend-admin
      target: development
    volumes:
      - ./frontend-admin:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true

  # ---------------------------------------------
  # 5. NGINX PUBLIC - Gateway Internet (solo frontend-user)
  # ---------------------------------------------
  nginx-public:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/public.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
      - ./i18n:/usr/share/nginx/html/i18n:ro
      - dev_static_volume:/var/www/static:ro
      - dev_media_volume:/var/www/media:ro
    depends_on:
      frontend-user:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - dev_frontend_public_network
      - dev_backend_network
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------
  # 6. NGINX INTRANET - Gateway Intranet (solo frontend-admin)
  # ---------------------------------------------
  nginx-intranet:
    image: nginx:alpine
    ports:
      - "127.0.0.1:8080:80" # BIND SOLO SU LOCALHOST - accesso via SSH tunnel
    volumes:
      - ./nginx/intranet.conf:/etc/nginx/nginx.conf:ro
      - ./i18n:/usr/share/nginx/html/i18n:ro
    depends_on:
      frontend-admin:
        condition: service_healthy
      backend:
        condition: service_healthy
      whatsapp-integration:
        condition: service_healthy
    networks:
      - dev_frontend_intranet_network
      - dev_backend_network
      - dev_whatsapp_intranet_network
    restart: always
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------
  # WHATSAPP INTEGRATION (Dev Overrides)
  # ---------------------------------------------

  # Integration Layer - Hot Reload Node.js
  whatsapp-integration:
    build:
      context: ./whatsapp-integration
      target: development
    volumes:
      - ./whatsapp-integration:/app
      - /app/node_modules
    # Esponiamo porta per debug diretto
    ports:
      - "4000:3000"

  # Worker Django (Esegue command custom in modalit√† dev con reload se supportato)
  backend-worker:
    build:
      context: ./backend
      target: development
    volumes:
      - ./backend:/app
    environment:
      DEBUG: "True"
