version: '3.8'

services:
  # ---------------------------------------------
  # BACKEND - Abilita Django Dev Server
  # ---------------------------------------------
  backend:
    build:
      context: ./backend
      target: development
    # Sovrascrive il comando gunicorn di produzione
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      # Monta il codice sorgente per rilevare modifiche .py
      - ./backend:/app
      # Assicura che i media files siano accessibili
      - media_volume:/app/media
    environment:
      - DEBUG=True

  # ---------------------------------------------
  # FRONTEND USER - Abilita Vite Dev Server
  # ---------------------------------------------
  frontend-user:
    build:
      context: ./frontend-user
      target: development
    volumes:
      # Sync bidirezionale codice host <-> container
      - ./frontend-user:/app
      # CRITICO: Preserva i node_modules del container evitando
      # che vengano sovrascritti dalla cartella locale (se assente)
      - /app/node_modules
    environment:
      # Polling necessario su alcuni sistemi (es. WSL2, Docker Desktop Windows)
      - CHOKIDAR_USEPOLLING=true

  # ---------------------------------------------
  # FRONTEND ADMIN - Abilita Vite Dev Server
  # ---------------------------------------------
  frontend-admin:
    build:
      context: ./frontend-admin
      target: development
    volumes:
      - ./frontend-admin:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true

  # ---------------------------------------------
  # WHATSAPP INTEGRATION (Dev)
  # ---------------------------------------------
  
  # Sessione Sposo
  waha-groom:
    image: devlikeapro/waha:latest
    restart: unless-stopped
    environment:
      WHATSAPP_API_KEY: ${WAHA_API_KEY_GROOM:-secret_groom}
      WHATSAPP_DEFAULT_SESSION: groom
      WHATSAPP_SWAGGER_USERNAME: admin
      WHATSAPP_SWAGGER_PASSWORD: ${DB_PASSWORD:-admin}
    volumes:
      - waha_groom_data:/app/.sessions
    networks:
      - whatsapp_intranet_network
    # In DEV esponiamo la dashboard per debug facile (http://localhost:3001/dashboard)
    ports:
      - "3001:3000"

  # Sessione Sposa
  waha-bride:
    image: devlikeapro/waha:latest
    restart: unless-stopped
    environment:
      WHATSAPP_API_KEY: ${WAHA_API_KEY_BRIDE:-secret_bride}
      WHATSAPP_DEFAULT_SESSION: bride
      WHATSAPP_SWAGGER_USERNAME: admin
      WHATSAPP_SWAGGER_PASSWORD: ${DB_PASSWORD:-admin}
    volumes:
      - waha_bride_data:/app/.sessions
    networks:
      - whatsapp_intranet_network
    # In DEV esponiamo la dashboard per debug facile (http://localhost:3002/dashboard)
    ports:
      - "3002:3000"

  # Integration Layer - Hot Reload Node.js
  whatsapp-integration:
    build:
      context: ./whatsapp-integration
      dockerfile: Dockerfile
    # In dev usiamo nodemon se installato, o semplicemente node con volume mounted
    # Per semplicit√† montiamo il volume per editare il codice senza rebuild
    command: node server.js 
    volumes:
      - ./whatsapp-integration:/app
      - /app/node_modules
    depends_on:
      - waha-groom
      - waha-bride
    environment:
      WAHA_GROOM_URL: http://waha-groom:3000
      WAHA_BRIDE_URL: http://waha-bride:3000
      WAHA_API_KEY_GROOM: ${WAHA_API_KEY_GROOM:-secret_groom}
      WAHA_API_KEY_BRIDE: ${WAHA_API_KEY_BRIDE:-secret_bride}
    networks:
      - whatsapp_intranet_network
    ports:
      - "4000:4000" # Esposto per debug diretto curl

  # Worker Django (Esegue command custom)
  backend-worker:
    build:
      context: ./backend
      target: development
    command: python manage.py run_whatsapp_worker
    volumes:
      - ./backend:/app
    depends_on:
      - db
      - whatsapp-integration
    environment:
      DATABASE_URL: postgres://postgres:${DB_PASSWORD:-changeme_in_prod}@db:5432/wedding_db
      WHATSAPP_INTEGRATION_URL: http://whatsapp-integration:4000
      DEBUG: "True"
    networks:
      - db_network
      - whatsapp_intranet_network

# Definizione Reti (Deve matchare prod per consistenza)
networks:
  whatsapp_intranet_network:
    driver: bridge

# Definizione Volumi (Per persistenza sessioni anche in dev)
volumes:
  waha_groom_data:
    driver: local
  waha_bride_data:
    driver: local
