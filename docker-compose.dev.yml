version: '3.8'

services:
  # ---------------------------------------------
  # BACKEND - Abilita Django Dev Server
  # ---------------------------------------------
  backend:
    build:
      context: ./backend
      target: development
    # Sovrascrive il comando gunicorn di produzione
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      # Monta il codice sorgente per rilevare modifiche .py
      - ./backend:/app
      # Assicura che i media files siano accessibili
      - media_volume:/app/media
    environment:
      - DEBUG=True

  # ---------------------------------------------
  # FRONTEND USER - Abilita Vite Dev Server
  # ---------------------------------------------
  frontend-user:
    build:
      context: ./frontend-user
      target: development
    volumes:
      # Sync bidirezionale codice host <-> container
      - ./frontend-user:/app
      # CRITICO: Preserva i node_modules del container evitando
      # che vengano sovrascritti dalla cartella locale (se assente)
      - /app/node_modules
    environment:
      # Polling necessario su alcuni sistemi (es. WSL2, Docker Desktop Windows)
      - CHOKIDAR_USEPOLLING=true

  # ---------------------------------------------
  # FRONTEND ADMIN - Abilita Vite Dev Server
  # ---------------------------------------------
  frontend-admin:
    build:
      context: ./frontend-admin
      target: development
    volumes:
      - ./frontend-admin:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true

  # ---------------------------------------------
  # WHATSAPP INTEGRATION (Dev Overrides)
  # ---------------------------------------------
  
  # Sessione Sposo - Solo expose porte dashboard
  waha-groom:
    # In DEV esponiamo la dashboard per debug facile (http://localhost:3001/dashboard)
    ports:
      - "3001:3000"
    environment:
      # Abilitiamo Swagger in dev per comodità
      WHATSAPP_SWAGGER_USERNAME: admin
      WHATSAPP_SWAGGER_PASSWORD: ${DB_PASSWORD:-admin}

  # Sessione Sposa - Solo expose porte dashboard
  waha-bride:
    # In DEV esponiamo la dashboard per debug facile (http://localhost:3002/dashboard)
    ports:
      - "3002:3000"
    environment:
      WHATSAPP_SWAGGER_USERNAME: admin
      WHATSAPP_SWAGGER_PASSWORD: ${DB_PASSWORD:-admin}

  # Integration Layer - Hot Reload Node.js
  whatsapp-integration:
    build:
      context: ./whatsapp-integration
      target: development
    volumes:
      - ./whatsapp-integration:/app
      - /app/node_modules
    # Esponiamo porta per debug diretto
    ports:
      - "4000:3000" 

  # Worker Django (Esegue command custom in modalità dev con reload se supportato)
  backend-worker:
    build:
      context: ./backend
      target: development
    volumes:
      - ./backend:/app
    environment:
      DEBUG: "True"
