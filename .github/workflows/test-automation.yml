name: Full Stack Test Suite

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ==============================================================================
  # 1. BACKEND TESTS (Matches run_all_tests.sh Section 1)
  # ==============================================================================
  backend-test:
    name: üêç Backend Tests (Pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest-cov
          
      - name: Run Pytest with Coverage
        run: |
          cd backend
          pytest -v --junitxml=test-results.xml --cov=core --cov-report=xml:coverage.xml --cov-report=term
      
      - name: Upload Backend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 7

  # ==============================================================================
  # 2. FRONTEND USER TESTS (Matches run_all_tests.sh Section 2)
  # ==============================================================================
  frontend-user-test:
    name: ‚öõÔ∏è Frontend User Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-user/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend-user
        run: npm ci
        
      - name: Run Vitest with Coverage
        working-directory: ./frontend-user
        run: npm run test -- --run --coverage
      
      - name: Upload User Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-user-coverage
          path: frontend-user/coverage/
          retention-days: 7

  # ==============================================================================
  # 3. FRONTEND ADMIN TESTS (Matches run_all_tests.sh Section 3)
  # ==============================================================================
  frontend-admin-test:
    name: üõ†Ô∏è Frontend Admin Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-admin/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend-admin
        run: npm ci
        
      - name: Run Vitest with Coverage
        working-directory: ./frontend-admin
        run: npm run test -- --run --coverage
      
      - name: Upload Admin Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-admin-coverage
          path: frontend-admin/coverage/
          retention-days: 7

  # ==============================================================================
  # 4. E2E TESTS (Matches run_all_tests.sh Section 4)
  # ==============================================================================
  e2e-test:
    name: üé≠ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-user-test, frontend-admin-test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Pre-requisite for E2E: Stack must be up (Script assumes this, CI must ensure it)
      - name: Build and Start Stack
        run: |
          if [ -f .env.example ]; then cp .env.example .env; fi
          docker compose up -d --build
          
      - name: Wait for Stack Health
        run: |
          timeout 60s bash -c 'until docker compose ps | grep "healthy"; do sleep 5; done' || docker compose logs
          
      - name: Set up Node.js for Playwright
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/e2e/package-lock.json
          
      - name: Install E2E Dependencies
        working-directory: ./tests/e2e
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: ./tests/e2e
        # Matches 'npx playwright install chromium' + deps from script
        run: |
          npx playwright install chromium
          npx playwright install-deps chromium
          
      - name: Run E2E Tests
        working-directory: ./tests/e2e
        run: npx playwright test
        env:
          BASE_URL: http://localhost
          
      - name: Upload Test Results (Report & Screenshots)
        if: always() # Upload results even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: |
            tests/e2e/playwright-report/
            tests/e2e/test-results/
          retention-days: 7
          
      - name: Dump Docker Logs on Failure
        if: failure()
        run: docker compose logs
