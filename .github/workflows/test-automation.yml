name: Full Stack Test Suite

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ==============================================================================
  # 1. BACKEND TESTS (Matches run_all_tests.sh Section 1)
  # ==============================================================================
  backend-test:
    name: ðŸ Backend Tests (Pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest-cov
          
      - name: Run Pytest with Coverage
        run: |
          set -o pipefail
          cd backend
          # Run pytest with --color=no to ensure clean logs
          pytest -v --color=no --junitxml=test-results.xml --cov=core --cov-report=xml:coverage.xml --cov-report=term | tee pytest-coverage.txt
      
      - name: Generate Backend Summary
        if: always()
        run: |
          echo "## ðŸ Backend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          # Clean up any potential ANSI codes just in case and take the last 30 lines
          sed 's/\x1b\[[0-9;]*m//g' backend/pytest-coverage.txt | tail -n 30 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Backend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 7

  # ==============================================================================
  # 2. FRONTEND USER TESTS (Matches run_all_tests.sh Section 2)
  # ==============================================================================
  frontend-user-test:
    name: âš›ï¸ Frontend User Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-user/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend-user
        run: npm ci
        
      - name: Run Vitest with Coverage
        working-directory: ./frontend-user
        env:
          FORCE_COLOR: 0
        run: |
          set -o pipefail
          # Add --no-color to explicitly disable Vitest coloring
          npm run test -- --run --coverage --no-color | tee coverage-output.txt
      
      - name: Generate User Frontend Summary
        if: always()
        working-directory: ./frontend-user
        run: |
          echo "## âš›ï¸ User Frontend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          # Use sed to strip any remaining ANSI escape codes
          sed 's/\x1b\[[0-9;]*m//g' coverage-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload User Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-user-coverage
          path: frontend-user/coverage/
          retention-days: 7

  # ==============================================================================
  # 3. FRONTEND ADMIN TESTS (Matches run_all_tests.sh Section 3)
  # ==============================================================================
  frontend-admin-test:
    name: ðŸ› ï¸ Frontend Admin Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-admin/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend-admin
        run: npm ci
        
      - name: Run Vitest with Coverage
        working-directory: ./frontend-admin
        env:
          FORCE_COLOR: 0
        run: |
          set -o pipefail
          # Add --no-color to explicitly disable Vitest coloring
          npm run test -- --run --coverage --no-color | tee coverage-output.txt
      
      - name: Generate Admin Frontend Summary
        if: always()
        working-directory: ./frontend-admin
        run: |
          echo "## ðŸ› ï¸ Admin Frontend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          # Use sed to strip any remaining ANSI escape codes
          sed 's/\x1b\[[0-9;]*m//g' coverage-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Admin Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-admin-coverage
          path: frontend-admin/coverage/
          retention-days: 7

  # ==============================================================================
  # 4. E2E TESTS (Matches run_all_tests.sh Section 4)
  # ==============================================================================
  e2e-test:
    name: ðŸŽ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-user-test, frontend-admin-test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Pre-requisite for E2E: Stack must be up (Script assumes this, CI must ensure it)
      - name: Build and Start Stack
        run: |
          if [ -f .env.example ]; then cp .env.example .env; fi
          docker compose up -d --build
          
      - name: Wait for Stack Health
        run: |
          timeout 60s bash -c 'until docker compose ps | grep "healthy"; do sleep 5; done' || docker compose logs
          
      - name: Set up Node.js for Playwright
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/e2e/package-lock.json
          
      - name: Install E2E Dependencies
        working-directory: ./tests/e2e
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: ./tests/e2e
        # Matches 'npx playwright install chromium' + deps from script
        run: |
          npx playwright install chromium
          npx playwright install-deps chromium
          
      - name: Run E2E Tests
        working-directory: ./tests/e2e
        run: npx playwright test
        env:
          BASE_URL: http://localhost
      
      - name: Generate E2E Summary
        if: always()
        run: |
          echo "## ðŸŽ­ E2E Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Test Suite Completed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Artifacts Available" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **Playwright HTML Report**: Detailed interactive report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¸ **Screenshots**: Captured on failure or specific checkpoints" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¼ **Traces**: Full execution traces for debugging" >> $GITHUB_STEP_SUMMARY
          
      - name: Upload Test Results (Report & Screenshots)
        if: always() # Upload results even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: |
            tests/e2e/playwright-report/
            tests/e2e/test-results/
          retention-days: 7
          
      - name: Dump Docker Logs on Failure
        if: failure()
        run: docker compose logs
