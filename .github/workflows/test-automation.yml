name: Full Stack Test Suite

on:
  workflow_dispatch:
    
jobs:
  # ==============================================================================
  # 0. STATIC CHECKS (i18n, linting)
  # ==============================================================================
  static-checks:
    name: ðŸ” Static Checks (i18n)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-user/package-lock.json

      - name: Run i18n Validation
        run: node i18n/scripts/i18n-check.js

  # ==============================================================================
  # 1. BACKEND TESTS (Matches run_all_tests.sh Section 1)
  # ==============================================================================
  backend-test:
    name: ðŸ Backend Tests (Pytest)
    needs: [static-checks]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install Dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest-cov
          
      - name: Run Pytest with Coverage
        run: |
          set -o pipefail
          cd backend
          # Run pytest with --color=no to ensure clean logs
          pytest -v --color=no --junitxml=test-results.xml --cov=core --cov-report=xml:coverage.xml --cov-report=term | tee pytest-coverage.txt
      
      - name: Generate Backend Summary
        if: always()
        run: |
          echo "## ðŸ Backend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          sed 's/\x1b\[[0-9;]*m//g' backend/pytest-coverage.txt | tail -n 30 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Backend Coverage
        uses: actions/upload-artifact@v6
        with:
          name: backend-coverage
          path: backend/coverage.xml
          retention-days: 7

  # ==============================================================================
  # 2. FRONTEND USER TESTS (Matches run_all_tests.sh Section 2)
  # ==============================================================================
  frontend-user-test:
    name: âš›ï¸ Frontend User Tests
    needs: [static-checks]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-user/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend-user
        run: npm ci
        
      - name: Run Vitest with Coverage
        working-directory: ./frontend-user
        env:
          FORCE_COLOR: 0
        run: |
          set -o pipefail
          npm run test -- --run --coverage --no-color | tee coverage-output.txt
      
      - name: Generate User Frontend Summary
        if: always()
        working-directory: ./frontend-user
        run: |
          echo "## âš›ï¸ User Frontend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          sed 's/\x1b\[[0-9;]*m//g' coverage-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload User Coverage
        uses: actions/upload-artifact@v6
        with:
          name: frontend-user-coverage
          path: frontend-user/coverage/
          retention-days: 7

  # ==============================================================================
  # 3. FRONTEND ADMIN TESTS (Matches run_all_tests.sh Section 3)
  # ==============================================================================
  frontend-admin-test:
    name: ðŸ› ï¸ Frontend Admin Tests
    needs: [static-checks]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-admin/package-lock.json

      - name: Install Dependencies
        working-directory: ./frontend-admin
        run: npm ci
        
      - name: Run Vitest with Coverage
        working-directory: ./frontend-admin
        env:
          FORCE_COLOR: 0
        run: |
          set -o pipefail
          npm run test -- --run --coverage --no-color | tee coverage-output.txt
      
      - name: Generate Admin Frontend Summary
        if: always()
        working-directory: ./frontend-admin
        run: |
          echo "## ðŸ› ï¸ Admin Frontend Test Results" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          sed 's/\x1b\[[0-9;]*m//g' coverage-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Admin Coverage
        uses: actions/upload-artifact@v6
        with:
          name: frontend-admin-coverage
          path: frontend-admin/coverage/
          retention-days: 7

  # ==============================================================================
  # 4. E2E & LOAD TESTS (Matches run_all_tests.sh Section 4)
  # ==============================================================================
  e2e-test:
    name: ðŸŽ­ E2E & Load Tests
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-user-test, frontend-admin-test]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Pre-requisite for E2E: Stack must be up (Script assumes this, CI must ensure it)
      - name: Build and Start Stack
        run: |
          if [ -f .env.example ]; then cp .env.example .env; fi
          # Force rebuilding pgbouncer to ensure latest config
          docker compose up -d --build
          
      - name: Wait for Stack Health
        run: |
          timeout 60s bash -c 'until docker compose ps | grep "healthy"; do sleep 5; done' || docker compose logs
      
      # ==========================================================================
      # SEED TEST DATA (Generate Valid Invitation)
      # ==========================================================================
      - name: Create Test Invitation
        id: seed
        run: |
          echo "Creating test data for load test..."
          output=$(docker compose exec -T backend python manage.py create_test_data)
          echo "$output"
          echo "$output" >> $GITHUB_ENV
          
      # ==========================================================================
      # LOAD TESTING (Connection Pooling)
      # ==========================================================================
      - name: Install Load Test Deps
        run: pip install requests
        
      - name: Run pgBouncer Load Test
        env:
          TEST_CODE: ${{ env.TEST_CODE }}
          TEST_TOKEN: ${{ env.TEST_TOKEN }}
        run: |
          echo "Running connection pooling load test with valid credentials..."
          python tests/load_test_connections.py > load-test-output.txt
          cat load-test-output.txt
          
      - name: Generate Load Test Summary
        if: always()
        run: |
          echo "## âš–ï¸ Connection Load Test (pgBouncer)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
          cat load-test-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # ==========================================================================
      # PLAYWRIGHT E2E TESTING
      # ==========================================================================
      - name: Set up Node.js for Playwright
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tests/e2e/package-lock.json
          
      - name: Install E2E Dependencies
        working-directory: ./tests/e2e
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: ./tests/e2e
        run: |
          npx playwright install chromium
          npx playwright install-deps chromium
          
      - name: Run E2E Tests
        working-directory: ./tests/e2e
        run: npx playwright test
        env:
          BASE_URL: http://localhost
      
      - name: Generate E2E Summary with Embed Images
        if: always()
        working-directory: ./tests/e2e
        run: |
          echo "## ðŸŽ­ E2E Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Test Suite Completed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¸ Captured Screenshots (Embedded)" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "test-results" ]; then
            count=0
            # Limit to 5 images to avoid hitting GitHub summary size limits (approx 1MB text limit)
            MAX_IMAGES=5
            
            find test-results -name "*.png" | head -n $MAX_IMAGES | while read img; do
              filename=$(basename "$img")
              echo "Processing $filename..."
              
              # Convert to base64 (remove newlines)
              b64data=$(base64 -w 0 "$img")
              
              # Append to summary as HTML image tag with Data URI
              echo "#### ðŸ–¼ï¸ $filename" >> $GITHUB_STEP_SUMMARY
              echo "<img src=\"data:image/png;base64,$b64data\" width=\"800\" alt=\"$filename\" />" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              count=$((count+1))
            done
            
            total_found=$(find test-results -name "*.png" | wc -l)
            if [ "$total_found" -gt "$MAX_IMAGES" ]; then
              echo "âš ï¸ _Shown first $MAX_IMAGES images only. Download artifacts to see all $(($total_found)) images._" >> $GITHUB_STEP_SUMMARY
            elif [ "$count" -eq "0" ]; then
              echo "No screenshots found." >> $GITHUB_STEP_SUMMARY
            fi
            
          else
             echo "No screenshots directory found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Results (Report & Screenshots)
        if: always() # Upload results even if tests fail
        uses: actions/upload-artifact@v6
        with:
          name: playwright-results
          path: |
            tests/e2e/playwright-report/
            tests/e2e/test-results/
          retention-days: 7
          
      - name: Dump Docker Logs on Failure
        if: failure()
        run: docker compose logs
