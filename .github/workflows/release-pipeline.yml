name: üöÄ Release & Publish

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  # ==============================================================================
  # 1. CALCULATE VERSION & CREATE RELEASE
  # ==============================================================================
  create-release:
    name: üè∑Ô∏è Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc_version.outputs.version }}
      # ESPOIRTIAMO LA VERSIONE PRECEDENTE (es. v2.0.0-rc8)
      previous_version: ${{ steps.calc_version.outputs.previous_version }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine Version Format
        id: format
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "version_format=\${major}.\${minor}.\${patch}" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          else
            echo "version_format=\${major}.\${minor}.\${patch}-rc\${increment}" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          fi

      - name: Calculate Next Version
        id: calc_version
        uses: PaulHatch/semantic-version@v6.0.0
        with:
          tag_prefix: ""
          major_pattern: "BREAKING CHANGE:"
          minor_pattern: "feat:"
          version_format: ${{ steps.format.outputs.version_format }}
          search_commit_body: true

      - name: Create Git Tag ${{ steps.calc_version.outputs.version }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag ${{ steps.calc_version.outputs.version }}
          git push origin ${{ steps.calc_version.outputs.version }}

      - name: Create GitHub Release ${{ steps.calc_version.outputs.version }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.calc_version.outputs.version }}
          name: Release ${{ steps.calc_version.outputs.version }}
          generate_release_notes: true
          prerelease: ${{ steps.format.outputs.is_prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==============================================================================
  # 2. BUILD & PUSH DOCKER IMAGES (Only if changed)
  # ==============================================================================
  build-and-publish:
    name: üê≥ ${{ matrix.service }}${{ needs.create-release.outputs.version }} Build & Push Docker
    needs: create-release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: backend
            context: ./backend
            dockerfile: ./backend/Dockerfile
            image_name: my-wedding-app-backend
            target: production
            build_args: ""
          - service: frontend-user
            context: ./frontend-user
            dockerfile: ./frontend-user/Dockerfile
            image_name: my-wedding-app-frontend-user
            target: production
            build_args: "REACT_APP_API_URL=/api"
          - service: frontend-admin
            context: ./frontend-admin
            dockerfile: ./frontend-admin/Dockerfile
            image_name: my-wedding-app-frontend-admin
            target: production
            build_args: "REACT_APP_API_URL=/api"
          - service: whatsapp-integration
            context: ./whatsapp-integration
            dockerfile: ./whatsapp-integration/Dockerfile
            image_name: my-wedding-app-whatsapp-integration
            target: production
            build_args: ""
          - service: nginx-public
            context: .
            dockerfile: ./nginx/Dockerfile
            image_name: my-wedding-app-nginx-public
            target: public
            build_args: ""
          - service: nginx-intranet
            context: .
            dockerfile: ./nginx/Dockerfile
            image_name: my-wedding-app-nginx-intranet
            target: intranet
            build_args: ""

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Necessario per controllare le differenze git

      # --------------------------------------------------------------------------
      # NUOVO STEP: Controllo cambiamenti
      # Confronta l'ultimo commit con il tag della versione precedente
      # --------------------------------------------------------------------------
      - name: Check for changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          # Confronta contro il tag precedente (o commit precedente)
          base: ${{ needs.create-release.outputs.previous_version }}
          filters: |
            src:
              - '${{ matrix.context }}/**'
              # Se hai librerie condivise che impattano tutti, aggiungile qui sotto:
              # - 'libs/shared/**'

      - name: Set up Docker Buildx
        # Eseguiamo il setup solo se dobbiamo buildare
        if: steps.changes.outputs.src == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: steps.changes.outputs.src == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker Metadata
        if: steps.changes.outputs.src == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.image_name }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.create-release.outputs.version }}
          labels: |
            org.opencontainers.image.version=${{ needs.create-release.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and Push (${{ matrix.service }})
        # L'IF FONDAMENTALE: esegue solo se 'src' √® true
        if: steps.changes.outputs.src == 'true'
        uses: docker/build-push-action@v6.18.0
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          target: ${{ matrix.target }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: ${{ matrix.build_args }}
          # GHA CACHE OPTIMIZATION:
          # Use 'scope' to share cache between different workflows (e.g. test-automation and release-pipeline)
          # We use the same cache key format used by buildx bake (default) or explicit scope.
          # To maximize hit rate, we can try to read from the cache generated by the test-automation workflow.
          # However, GHA cache scoping rules are strict (branch isolation).
          # 'main' branch cache is accessible to child branches, but sibling branches might be tricky.
          # Here we just enable GHA cache for this workflow itself to speed up subsequent releases.
          cache-from: type=gha,scope=build-${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=build-${{ matrix.service }}

      # Opzionale: stampa un messaggio se lo skip avviene
      - name: Skip Notification
        if: steps.changes.outputs.src != 'true'
        run: echo "‚ö†Ô∏è Nessuna modifica rilevata in ${{ matrix.context }}. Skipping build."
