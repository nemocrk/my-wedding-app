services:
  # ---------------------------------------------
  # 1. DATABASE - Completamente isolato
  # ---------------------------------------------
  db:
    image: postgres:alpine
    restart: always
    environment:
      POSTGRES_DB: wedding_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme_in_prod}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - db_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------
  # 1b. ADMINER - Web GUI per Database
  # ---------------------------------------------
  adminer:
    image: adminer
    restart: always
    ports:
      - "8081:8080"
    networks:
      - db_network               # Per parlare con il DB
      - frontend_intranet_network # Per essere raggiungibile dall'host (bypass internal flag)
    depends_on:
      - db
    environment:
      ADMINER_DEFAULT_SERVER: db

  # ---------------------------------------------
  # 2. BACKEND API - Gunicorn per produzione
  # ---------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-production}
    command: gunicorn wedding.wsgi:application --bind 0.0.0.0:8000 --workers 4
    volumes:
      - ./backend:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:${DB_PASSWORD:-changeme_in_prod}@db:5432/wedding_db
      DJANGO_SETTINGS_MODULE: wedding.settings
      SECRET_KEY: ${DJANGO_SECRET_KEY:-dev-secret-key-change-in-prod}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1}
      DEBUG: ${DEBUG:-False}
    networks:
      - db_network
      - backend_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    expose:
      - "8000"

  # ---------------------------------------------
  # 3. FRONTEND USER - Internet pubblico via Nginx
  # ---------------------------------------------
  frontend-user:
    build:
      context: ./frontend-user
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-production}
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost/api}
    volumes:
      - ./frontend-user/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - frontend_public_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    expose:
      - "80"

  # ---------------------------------------------
  # 4. FRONTEND ADMIN - Solo Intranet
  # ---------------------------------------------
  frontend-admin:
    build:
      context: ./frontend-admin
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-production}
      args:
        REACT_APP_API_URL: ${REACT_APP_ADMIN_API_URL:-http://localhost:8080/api}
    volumes:
      - ./frontend-admin/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - frontend_intranet_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    expose:
      - "80"

  # ---------------------------------------------
  # 5. NGINX PUBLIC - Gateway Internet (solo frontend-user)
  # ---------------------------------------------
  nginx-public:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/public.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
      - static_volume:/var/www/static:ro
      - media_volume:/var/www/media:ro
    depends_on:
      frontend-user:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - frontend_public_network
      - backend_network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------
  # 6. NGINX INTRANET - Gateway Intranet (solo frontend-admin)
  # ---------------------------------------------
  nginx-intranet:
    image: nginx:alpine
    ports:
      - "127.0.0.1:8080:80"  # BIND SOLO SU LOCALHOST - accesso via SSH tunnel
    volumes:
      - ./nginx/intranet.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      frontend-admin:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - frontend_intranet_network
      - backend_network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# ---------------------------------------------
# RETI - Isolamento completo tra componenti
# ---------------------------------------------
networks:
  # Rete database - completamente isolata da Internet
  db_network:
    internal: true
    driver: bridge
  
  # Rete backend - isolata, solo per comunicazione backend<->nginx
  backend_network:
    internal: true
    driver: bridge
  
  # Rete frontend pubblico - accessibile da Internet via nginx-public
  frontend_public_network:
    driver: bridge
  
  # Rete frontend intranet - accessibile solo via localhost
  frontend_intranet_network:
    driver: bridge

# ---------------------------------------------
# VOLUMI PERSISTENTI
# ---------------------------------------------
volumes:
  postgres_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local
