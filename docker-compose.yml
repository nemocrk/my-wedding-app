services:
  # ---------------------------------------------
  # 1. DATABASE - Completamente isolato
  # ---------------------------------------------
  db:
    image: postgres:alpine
    restart: always
    environment:
      POSTGRES_DB: wedding_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme_in_prod}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - db_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------
  # 1b. ADMINER - Web GUI per Database
  # ---------------------------------------------
  adminer:
    image: adminer
    restart: always
    ports:
      - "8081:8080"
    networks:
      - db_network               # Per parlare con il DB
      - frontend_intranet_network # Per essere raggiungibile dall'host (bypass internal flag)
    depends_on:
      - db
    environment:
      ADMINER_DEFAULT_SERVER: db

  # ---------------------------------------------
  # 1c. PGBOUNCER - Connection Pooler per PostgreSQL
  # ---------------------------------------------
  pgbouncer:
    # Usciamo dall'immagine ufficiale (dns issues) e usiamo la più robusta edoburu
    image: edoburu/pgbouncer:latest
    restart: always
    environment:
      # Configurazione Backend DB
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: ${DB_PASSWORD:-changeme_in_prod}
      DB_NAME: wedding_db
      
      # Configurazione Pooling
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 200
      DEFAULT_POOL_SIZE: 25
      MIN_POOL_SIZE: 5
      RESERVE_POOL_SIZE: 5
      SERVER_IDLE_TIMEOUT: 600
      
      # Configurazione Auth e Network
      LISTEN_PORT: 5432
      # FIX: Postgres 14 usa SCRAM-SHA-256. 
      # AUTH_TYPE=any richiederebbe auth_user, ma l'immagine non supporta AUTH_USER env var.
      # Usiamo scram-sha-256 che è il default corretto.
      # L'immagine edoburu genera userlist.txt con la password in chiaro (da DB_PASSWORD),
      # permettendo a pgbouncer di fare l'handshake SCRAM.
      AUTH_TYPE: scram-sha-256
      ADMIN_USERS: postgres
      
      # Fix DNS Docker issues
      DNS_MAX_TTL: 15
      DNS_ZONE_CHECK_PERIOD: 0
    networks:
      - db_network
    depends_on:
      db:
        condition: service_healthy
    # Healthcheck basato su connessione TCP aperta
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 5432 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    expose:
      - "5432"

  # ---------------------------------------------
  # 2. BACKEND API - Gunicorn per produzione
  # ---------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-production}
    command: gunicorn wedding.wsgi:application --bind 0.0.0.0:8000 --workers 4
    volumes:
      - ./backend:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    depends_on:
      db:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:${DB_PASSWORD:-changeme_in_prod}@pgbouncer:5432/wedding_db
      DJANGO_SETTINGS_MODULE: wedding.settings
      SECRET_KEY: ${DJANGO_SECRET_KEY:-dev-secret-key-change-in-prod}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1}
      DEBUG: ${DEBUG:-False}
      FRONTEND_PUBLIC_URL: ${FRONTEND_PUBLIC_URL:-http://localhost}
    networks:
      - db_network
      - backend_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    expose:
      - "8000"
      
  # ---------------------------------------------
  # 2b. BACKEND WORKER - Gestore Coda Messaggi
  # ---------------------------------------------
  backend-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-production}
    command: python manage.py run_whatsapp_worker
    restart: always
    volumes:
      - ./backend:/app
      - static_volume_worker:/app/staticfiles
      - media_volume_worker:/app/media
    depends_on:
      backend:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:${DB_PASSWORD:-changeme_in_prod}@pgbouncer:5432/wedding_db
      DJANGO_SETTINGS_MODULE: wedding.settings
      SECRET_KEY: ${DJANGO_SECRET_KEY:-dev-secret-key-change-in-prod}
      WAHA_WORKER_INTERVAL: ${WAHA_WORKER_INTERVAL:-60}
      WA_INTEGRATION_URL: http://whatsapp-integration:3000
    networks:
      - db_network
      - whatsapp_intranet_network

  # ---------------------------------------------
  # 3. FRONTEND USER - Internet pubblico via Nginx
  # ---------------------------------------------
  frontend-user:
    build:
      context: ./frontend-user
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-production}
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost/api}
    volumes:
      - ./frontend-user/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - frontend_public_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    expose:
      - "80"

  # ---------------------------------------------
  # 4. FRONTEND ADMIN - Solo Intranet
  # ---------------------------------------------
  frontend-admin:
    build:
      context: ./frontend-admin
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-production}
      args:
        REACT_APP_API_URL: ${REACT_APP_ADMIN_API_URL:-http://localhost:8080/api}
    volumes:
      - ./frontend-admin/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - frontend_intranet_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    expose:
      - "80"

  # ---------------------------------------------
  # 5. NGINX PUBLIC - Gateway Internet (solo frontend-user)
  # ---------------------------------------------
  nginx-public:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/public.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
      - ./i18n:/usr/share/nginx/html/i18n:ro
      - static_volume:/var/www/static:ro
      - media_volume:/var/www/media:ro
    depends_on:
      frontend-user:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - frontend_public_network
      - backend_network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------
  # 6. NGINX INTRANET - Gateway Intranet (solo frontend-admin)
  # ---------------------------------------------
  nginx-intranet:
    image: nginx:alpine
    ports:
      - "127.0.0.1:8080:80"  # BIND SOLO SU LOCALHOST - accesso via SSH tunnel
    volumes:
      - ./nginx/intranet.conf:/etc/nginx/nginx.conf:ro
      - ./i18n:/usr/share/nginx/html/i18n:ro
    depends_on:
      frontend-admin:
        condition: service_healthy
      backend:
        condition: service_healthy
      whatsapp-integration:
         condition: service_healthy
    networks:
      - frontend_intranet_network
      - backend_network
      - whatsapp_intranet_network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  # ---------------------------------------------
  # 7. WHATSAPP SERVICES (Isolated)
  # ---------------------------------------------
  
  # WAHA Core - Sposo
  waha-groom:
    image: devlikeapro/waha:latest
    restart: on-failure
    environment:
      # Free Tier config (no swagger, no dashboard in prod)
      WHATSAPP_DEFAULT_ENGINE: 'WEBJS'
      WHATSAPP_WEBHOOK_URL: 'http://whatsapp-integration:3000/webhook/groom'
      WAHA_API_KEY: ${WAHA_API_KEY_GROOM:-secret}
      # Disabilita il print del QR nei log (evita confusione - il QR viene servito via API)
      WAHA_PRINT_QR: 'false'
    networks:
      - whatsapp_intranet_network
      - whatsapp_public_network # Uscita Internet dedicata
    volumes:
      # Store sessions in the .sessions folder (WAHA default path)
      - waha_groom_sessions:/app/.sessions
      # Save media files (WAHA default path)
      - waha_groom_media:/app/.media
    expose:
      - "3000"
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider --header='X-Api-Key: ${WAHA_API_KEY_GROOM:-secret}' http://localhost:3000/api/server/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

  # WAHA Core - Sposa
  waha-bride:
    image: devlikeapro/waha:latest
    restart: on-failure
    environment:
      WHATSAPP_DEFAULT_ENGINE: 'WEBJS'
      WHATSAPP_WEBHOOK_URL: 'http://whatsapp-integration:3000/webhook/bride'
      WAHA_API_KEY: ${WAHA_API_KEY_BRIDE:-secret}
      # Disabilita il print del QR nei log (evita confusione - il QR viene servito via API)
      WAHA_PRINT_QR: 'false'
    networks:
      - whatsapp_intranet_network
      - whatsapp_public_network # Uscita Internet dedicata
    volumes:
      # Store sessions in the .sessions folder (WAHA default path)
      - waha_bride_sessions:/app/.sessions
      # Save media files (WAHA default path)
      - waha_bride_media:/app/.media
    expose:
      - "3000"
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider --header='X-Api-Key: ${WAHA_API_KEY_BRIDE:-secret}' http://localhost:3000/api/server/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

  # Integration Layer (Proxy & Logic)
  whatsapp-integration:
    build:
      context: ./whatsapp-integration
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-production}
    restart: always
    depends_on:
      waha-groom:
        condition: service_healthy
      waha-bride:
        condition: service_healthy
    environment:
      PORT: 3000
      WAHA_GROOM_URL: 'http://waha-groom:3000'
      WAHA_BRIDE_URL: 'http://waha-bride:3000'
      WAHA_API_KEY_GROOM: ${WAHA_API_KEY_GROOM:-secret}
      WAHA_API_KEY_BRIDE: ${WAHA_API_KEY_BRIDE:-secret}
      DJANGO_API_URL: 'http://backend:8000/api/admin'
    networks:
      - backend_network          # Per comunicare con Django
      - whatsapp_intranet_network # Per parlare con container WAHA
    expose:
      - "3000"
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# ---------------------------------------------
# RETI - Isolamento completo tra componenti
# ---------------------------------------------
networks:
  # Rete database - completamente isolata da Internet
  db_network:
    internal: true
    driver: bridge
  
  # Rete backend - isolata, solo per comunicazione backend<->nginx
  backend_network:
    internal: true
    driver: bridge
  
  # Rete frontend pubblico - accessibile da Internet via nginx-public
  frontend_public_network:
    driver: bridge
  
  # Rete frontend intranet - accessibile solo via localhost
  frontend_intranet_network:
    driver: bridge
    
  # Rete whatsapp - isolata per container waha
  whatsapp_intranet_network:
    internal: true
    driver: bridge
  
  # Rete dedicata per accesso internet WhatsApp
  whatsapp_public_network:
    driver: bridge
    # NON internal: true, altrimenti non esce su internet

# ---------------------------------------------
# VOLUMI PERSISTENTI
# ---------------------------------------------
volumes:
  postgres_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local
  static_volume_worker:
    driver: local
  media_volume_worker:
    driver: local
  # WAHA Groom volumes (separati per sessions e media)
  waha_groom_sessions:
    driver: local
  waha_groom_media:
    driver: local
  # WAHA Bride volumes (separati per sessions e media)
  waha_bride_sessions:
    driver: local
  waha_bride_media:
    driver: local
